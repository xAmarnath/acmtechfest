<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream Control - ASTERISK</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.cdnfonts.com/css/valorant" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            background-image: url('https://56ktpin8ut.ucarecd.net/1e09c958-9b5a-4501-b491-6c06a5295b34/LzC.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255, 0, 60, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 60, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 1;
        }

        .font-rajdhani {
            font-family: 'Rajdhani', sans-serif;
        }

        .font-valorant {
            font-family: 'Valorant', sans-serif;
        }

        /* Header */
        .header {
            position: relative;
            z-index: 100;
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(255, 0, 60, 0.3);
            padding: 1.5rem 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-family: 'Valorant', 'Rajdhani', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .header h1 span {
            color: #ff003c;
            text-shadow: 0 0 20px rgba(255, 0, 60, 0.8);
        }

        .header-stats {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .stat-badge {
            background: linear-gradient(135deg, rgba(255, 0, 60, 0.15), rgba(0, 255, 247, 0.1));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 0, 60, 0.3);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 0 100%);
        }

        .stat-value {
            color: #ff003c;
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* Container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 30px rgba(255, 0, 60, 0.5);
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.1rem;
            margin-bottom: 2rem;
            font-weight: 500;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Card */
        .card {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 0, 60, 0.3);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 0 100%);
        }

        .card:hover {
            border-color: #ff003c;
            box-shadow: 0 10px 40px rgba(255, 0, 60, 0.3);
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, rgba(255, 0, 60, 0.2), rgba(0, 255, 247, 0.1));
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 0, 60, 0.3);
        }

        .card-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 0, 60, 0.3);
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff003c;
            box-shadow: 0 0 15px rgba(255, 0, 60, 0.3);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .helper-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin-top: 0.3rem;
            font-style: italic;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #ff003c, #ff335c);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 0 100%);
        }

        .btn:hover {
            background: linear-gradient(135deg, #ff335c, #ff003c);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 0, 60, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(0, 255, 247, 0.8), rgba(0, 200, 200, 0.8));
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(0, 255, 247, 1), rgba(0, 200, 200, 1));
            box-shadow: 0 8px 20px rgba(0, 255, 247, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, rgba(0, 255, 100, 0.8), rgba(0, 200, 80, 0.8));
        }

        .btn-success:hover {
            background: linear-gradient(135deg, rgba(0, 255, 100, 1), rgba(0, 200, 80, 1));
            box-shadow: 0 8px 20px rgba(0, 255, 100, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(255, 50, 50, 0.8), rgba(200, 0, 0, 0.8));
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, rgba(255, 50, 50, 1), rgba(200, 0, 0, 1));
            box-shadow: 0 8px 20px rgba(255, 50, 50, 0.4);
        }

        /* Team Score Display */
        .team-score-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 0, 60, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .team-side {
            flex: 1;
            text-align: center;
        }

        .team-name {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .team-score {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ff003c;
            font-family: 'Rajdhani', sans-serif;
        }

        .vs-divider {
            font-size: 1.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.3);
            padding: 0 1rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 0, 60, 0.5);
            border-left: 4px solid #ff003c;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            z-index: 10000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-color: rgba(0, 255, 100, 0.5);
            border-left-color: #00ff64;
        }

        .notification.error {
            border-color: rgba(255, 50, 50, 0.5);
            border-left-color: #ff3232;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .header-stats {
                flex-wrap: wrap;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Glow Effects */
        .glow-red {
            text-shadow: 0 0 10px rgba(255, 0, 60, 0.8);
        }

        .glow-cyan {
            text-shadow: 0 0 10px rgba(0, 255, 247, 0.8);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>
                <span class="iconify" data-icon="mdi:broadcast" style="color: #ff003c;"></span>
                <span>ASTERISK</span> STREAM CONTROL
            </h1>
            <div class="header-stats">
                <div class="stat-badge">
                    <span class="iconify" data-icon="mdi:eye" style="font-size: 1.5rem; color: #00fff7;"></span>
                    <span>Viewers:</span>
                    <span class="stat-value" id="viewerCount">0</span>
                </div>
                <div class="stat-badge">
                    <span class="iconify" data-icon="mdi:circle" id="liveIndicator" style="font-size: 1rem; color: #ff003c;"></span>
                    <span id="statusText">READY</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <h2 class="page-title">LIVE STREAM CONTROLS</h2>
        <p class="page-subtitle">Manage your stream overlay, scores, and match information in real-time</p>

        <!-- Grid Layout -->
        <div class="grid">
            <!-- Team Scores Card -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span class="iconify" data-icon="mdi:scoreboard" style="color: #ff003c;"></span>
                        Team Scores
                    </h3>
                </div>
                <div class="card-body">
                    <div class="team-score-display">
                        <div class="team-side">
                            <div class="team-name" id="displayTeam1">TEAM ALPHA</div>
                            <div class="team-score" id="displayScore1">0</div>
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="team-side">
                            <div class="team-name" id="displayTeam2">TEAM OMEGA</div>
                            <div class="team-score" id="displayScore2">0</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Team 1 Score</label>
                        <input type="number" id="team1Score" class="form-input" placeholder="0" min="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Team 2 Score</label>
                        <input type="number" id="team2Score" class="form-input" placeholder="0" min="0">
                    </div>

                    <div class="button-group">
                        <button class="btn" onclick="updateScore()">
                            <span class="iconify" data-icon="mdi:update"></span>
                            Update Scores
                        </button>
                        <button class="btn btn-secondary" onclick="resetScores()">
                            <span class="iconify" data-icon="mdi:refresh"></span>
                            Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Team Names Card -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span class="iconify" data-icon="mdi:account-group" style="color: #00fff7;"></span>
                        Team Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Team 1 Name</label>
                        <input type="text" id="team1Name" class="form-input" placeholder="TEAM ALPHA">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Team 1 Subtitle</label>
                        <input type="text" id="team1Subtitle" class="form-input" placeholder="Attackers">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Team 2 Name</label>
                        <input type="text" id="team2Name" class="form-input" placeholder="TEAM OMEGA">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Team 2 Subtitle</label>
                        <input type="text" id="team2Subtitle" class="form-input" placeholder="Defenders">
                    </div>

                    <button class="btn" onclick="updateTeams()">
                        <span class="iconify" data-icon="mdi:check"></span>
                        Update Teams
                    </button>
                </div>
            </div>

            <!-- Match Info Card -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span class="iconify" data-icon="mdi:map-marker" style="color: #d4af37;"></span>
                        Match Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Map Name</label>
                        <input type="text" id="mapName" class="form-input" placeholder="HAVEN">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Round (e.g., 1/24)</label>
                        <input type="text" id="roundNumber" class="form-input" placeholder="1/24">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Best Of (e.g., BO3)</label>
                        <input type="text" id="bestOf" class="form-input" placeholder="BO3">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Match Title</label>
                        <input type="text" id="matchTitle" class="form-input" placeholder="Grand Finals â€” ASTERISK 2025">
                    </div>

                    <button class="btn" onclick="updateMatchInfo()">
                        <span class="iconify" data-icon="mdi:update"></span>
                        Update Match Info
                    </button>
                </div>
            </div>

            <!-- HLS Stream Source Card -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span class="iconify" data-icon="mdi:video-wireless" style="color: #ff003c;"></span>
                        HLS Stream Source
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Stream URL (m3u8)</label>
                        <input type="text" id="ingressServer" class="form-input" placeholder="http://localhost:5001/hls/stream.m3u8">
                        <p class="helper-text">Enter the m3u8 URL for the HLS stream source</p>
                    </div>

                    <div class="button-group">
                        <button class="btn" onclick="updateIngressServer()">
                            <span class="iconify" data-icon="mdi:content-save"></span>
                            Save Stream URL
                        </button>
                        <button class="btn btn-secondary" onclick="testStreamSource()">
                            <span class="iconify" data-icon="mdi:play-network"></span>
                            Test Stream
                        </button>
                    </div>
                </div>
            </div>

            <!-- Match Control Card -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span class="iconify" data-icon="mdi:controller" style="color: #00ff64;"></span>
                        Match Controls
                    </h3>
                </div>
                <div class="card-body">
                    <p class="helper-text" style="margin-bottom: 1rem;">
                        Trigger overlay animations for match start and end events
                    </p>

                    <div class="button-group" style="flex-direction: column;">
                        <button class="btn btn-success" onclick="triggerMatchStart()">
                            <span class="iconify" data-icon="mdi:sword-cross"></span>
                            Trigger Match Start
                        </button>
                        <button class="btn btn-danger" onclick="triggerMatchEnd()">
                            <span class="iconify" data-icon="mdi:trophy"></span>
                            Trigger Match End
                        </button>
                        <button class="btn btn-secondary" onclick="resetMatch()">
                            <span class="iconify" data-icon="mdi:restore"></span>
                            Reset Everything
                        </button>
                    </div>
                </div>
            </div>

            <!-- Broadcast Message Card -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span class="iconify" data-icon="mdi:message-flash" style="color: #ffd700;"></span>
                        Broadcast Message
                    </h3>
                </div>
                <div class="card-body">
                    <p class="helper-text" style="margin-bottom: 1rem;">
                        Send a chat message to all viewers watching the stream
                    </p>

                    <button class="btn btn-success" onclick="openChatModal()" style="width: 100%;">
                        <span class="iconify" data-icon="mdi:message-text"></span>
                        Send Chat Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; margin: 2rem;">
            <div class="card-header">
                <h3>
                    <span class="iconify" data-icon="mdi:message-text" style="color: #00fff7;"></span>
                    Send Broadcast Message
                </h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Message (Max 150 characters)</label>
                    <input type="text" id="chatMessage" class="form-input" placeholder="Type your message..." maxlength="150">
                    <p class="helper-text" id="charCount">0 / 150 characters</p>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeChatModal()">
                        <span class="iconify" data-icon="mdi:close"></span>
                        Cancel
                    </button>
                    <button class="btn btn-success" onclick="sendChat()">
                        <span class="iconify" data-icon="mdi:send"></span>
                        Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://30c61382b1f2.ngrok-free.app/api';
        const AUTH_TOKEN = '0022';

        // Load initial state
        async function loadState() {
            try {
                const response = await fetch(`${API_BASE}/match-state`);
                const state = await response.json();
                
                document.getElementById('team1Name').value = state.team1.name;
                document.getElementById('team1Subtitle').value = state.team1.subtitle;
                document.getElementById('team1Score').value = state.team1.score;
                
                document.getElementById('team2Name').value = state.team2.name;
                document.getElementById('team2Subtitle').value = state.team2.subtitle;
                document.getElementById('team2Score').value = state.team2.score;
                
                document.getElementById('mapName').value = state.map;
                document.getElementById('roundNumber').value = state.round;
                document.getElementById('bestOf').value = state.bestOf;
                document.getElementById('matchTitle').value = state.matchTitle;
                
                updateDisplay(state);
                
                // Load ingress server
                await loadIngressServer();
            } catch (error) {
                console.error('Error loading state:', error);
                showNotification('Failed to load state', 'error');
            }
        }

        async function loadIngressServer() {
            try {
                const response = await fetch(`${API_BASE}/ingress-server`);
                const data = await response.json();
                if (data.ingress_server) {
                    document.getElementById('ingressServer').value = data.ingress_server;
                }
            } catch (error) {
                console.error('Error loading ingress server:', error);
            }
        }

        function updateDisplay(state) {
            document.getElementById('displayTeam1').textContent = state.team1.name;
            document.getElementById('displayScore1').textContent = state.team1.score;
            document.getElementById('displayTeam2').textContent = state.team2.name;
            document.getElementById('displayScore2').textContent = state.team2.score;
        }

        async function updateScore() {
            const team1Score = parseInt(document.getElementById('team1Score').value) || 0;
            const team2Score = parseInt(document.getElementById('team2Score').value) || 0;
            
            try {
                await fetch(`${API_BASE}/update-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team: 1, score: team1Score })
                });
                
                await fetch(`${API_BASE}/update-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team: 2, score: team2Score })
                });
                
                showNotification('Scores updated!', 'success');
                loadState();
            } catch (error) {
                console.error('Error updating score:', error);
                showNotification('Failed to update scores', 'error');
            }
        }

        async function resetScores() {
            document.getElementById('team1Score').value = 0;
            document.getElementById('team2Score').value = 0;
            await updateScore();
        }

        async function updateTeams() {
            const team1Name = document.getElementById('team1Name').value;
            const team1Subtitle = document.getElementById('team1Subtitle').value;
            const team2Name = document.getElementById('team2Name').value;
            const team2Subtitle = document.getElementById('team2Subtitle').value;
            
            try {
                await fetch(`${API_BASE}/update-teams`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team1: { name: team1Name, subtitle: team1Subtitle },
                        team2: { name: team2Name, subtitle: team2Subtitle }
                    })
                });
                
                showNotification('Team info updated!', 'success');
                loadState();
            } catch (error) {
                console.error('Error updating teams:', error);
                showNotification('Failed to update teams', 'error');
            }
        }

        async function updateMatchInfo() {
            const mapName = document.getElementById('mapName').value;
            const roundNumber = document.getElementById('roundNumber').value;
            const bestOf = document.getElementById('bestOf').value;
            const matchTitle = document.getElementById('matchTitle').value;
            
            try {
                await fetch(`${API_BASE}/update-match-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        map: mapName,
                        round: roundNumber,
                        bestOf: bestOf,
                        matchTitle: matchTitle
                    })
                });
                
                showNotification('Match info updated!', 'success');
            } catch (error) {
                console.error('Error updating match info:', error);
                showNotification('Failed to update match info', 'error');
            }
        }

        async function updateIngressServer() {
            const url = document.getElementById('ingressServer').value.trim();
            
            if (!url) {
                showNotification('Please enter a stream URL', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/ingress-server`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Auth-Token': AUTH_TOKEN
                    },
                    body: JSON.stringify({ ingress_server: url })
                });
                
                if (response.ok) {
                    showNotification('Stream URL saved!', 'success');
                } else {
                    showNotification('Failed to save stream URL', 'error');
                }
            } catch (error) {
                console.error('Error saving ingress server:', error);
                showNotification('Error saving stream URL', 'error');
            }
        }

        async function testStreamSource() {
            const url = document.getElementById('ingressServer').value.trim();
            
            if (!url) {
                showNotification('Please enter a stream URL first', 'error');
                return;
            }
            
            showNotification('Testing stream...', 'success');
            
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    showNotification('âœ… Stream is accessible!', 'success');
                } else {
                    showNotification('âŒ Cannot access stream', 'error');
                }
            } catch (error) {
                showNotification('âŒ Stream test failed', 'error');
            }
        }

        async function triggerMatchStart() {
            try {
                await fetch(`${API_BASE}/control/start-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showNotification('ðŸŽ® Match start animation triggered!', 'success');
            } catch (error) {
                console.error('Error triggering match start:', error);
                showNotification('Failed to trigger match start', 'error');
            }
        }

        async function triggerMatchEnd() {
            try {
                await fetch(`${API_BASE}/control/end-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showNotification('ðŸ† Match end animation triggered!', 'success');
            } catch (error) {
                console.error('Error triggering match end:', error);
                showNotification('Failed to trigger match end', 'error');
            }
        }

        async function resetMatch() {
            if (!confirm('Reset all match data to defaults?')) return;
            
            try {
                await fetch(`${API_BASE}/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showNotification('Match reset!', 'success');
                loadState();
            } catch (error) {
                console.error('Error resetting match:', error);
                showNotification('Failed to reset match', 'error');
            }
        }

        // Chat Modal Functions
        function openChatModal() {
            document.getElementById('chatModal').style.display = 'flex';
            document.getElementById('chatMessage').focus();
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
            document.getElementById('chatMessage').value = '';
            document.getElementById('charCount').textContent = '0 / 150 characters';
        }

        async function sendChat() {
            const message = document.getElementById('chatMessage').value.trim();
            
            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/send-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, viewerId: 'admin-panel' })
                });
                
                closeChatModal();
                showNotification('ðŸ’¬ Message broadcasted to all viewers!', 'success');
            } catch (error) {
                console.error('Error sending chat:', error);
                showNotification('Failed to send message', 'error');
            }
        }

        // Character counter for chat
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatMessage');
            if (chatInput) {
                chatInput.addEventListener('input', (e) => {
                    const count = e.target.value.length;
                    document.getElementById('charCount').textContent = `${count} / 150 characters`;
                });
                
                // Send on Enter key
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChat();
                    }
                });
            }
            
            // Close modal on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('chatModal').style.display === 'flex') {
                    closeChatModal();
                }
            });
        });

        // Viewer count update
        async function updateViewerCount() {
            try {
                const response = await fetch(`${API_BASE}/viewer-count`);
                const data = await response.json();
                document.getElementById('viewerCount').textContent = data.count || 0;
            } catch (error) {
                console.error('Error fetching viewer count:', error);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'mdi:check-circle' : 'mdi:alert-circle';
            const iconColor = type === 'success' ? '#00ff64' : '#ff3232';
            
            notification.innerHTML = `
                <span class="iconify" data-icon="${icon}" style="font-size: 1.5rem; color: ${iconColor};"></span>
                <span style="font-weight: 600;">${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 500);
            }, 3000);
        }

        // Initialize
        loadState();
        updateViewerCount();
        setInterval(updateViewerCount, 5000);

        console.log('ðŸŽ® ASTERISK Stream Control Panel initialized');
    </script>
</body>
</html>
